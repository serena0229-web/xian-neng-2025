<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™›èƒ½å°¾ç‰™ï¼šçµ‚æ¥µç©åˆ†é–‹çè³½</title>
    <style>
        :root {
            --neon-gold: #ffea00;
            --neon-red: #ff003c;
            --bg-dark: #0a0a0c;
        }
        body { 
            background: var(--bg-dark); color: white; margin: 0; padding: 10px;
            font-family: -apple-system, "Microsoft JhengHei", sans-serif;
            display: flex; flex-direction: column; align-items: center; min-height: 100vh;
            overflow-x: hidden;
        }
        .header { text-align: center; margin-bottom: 10px; }
        h1 { font-size: 1.8rem; color: var(--neon-gold); text-shadow: 0 0 15px #ffea00; margin: 5px 0; }
        .info-bar { font-size: 1rem; color: #ff003c; font-weight: bold; margin-bottom: 5px; }

        /* 23äººç¶²æ ¼ä½ˆå±€ */
        .battle-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; width: 100%; max-width: 500px;
        }
        .slot-card {
            background: #1a1a1e; border: 1px solid #333; border-radius: 8px;
            padding: 8px 2px; text-align: center; position: relative; transition: 0.3s;
        }
        .slot-card.spinning { border-color: var(--neon-red); animation: pulse 0.15s infinite; }
        .slot-card.already-won { opacity: 0.4; filter: grayscale(1); border-color: #000; }
        .slot-name { font-size: 0.75rem; display: block; margin-bottom: 3px; color: #ccc; }
        .slot-count { font-size: 1.3rem; font-weight: 900; color: var(--neon-gold); }

        .mini-wheel {
            width: 25px; height: 25px; border: 2px solid var(--neon-gold);
            border-radius: 50%; margin: 0 auto; border-top-color: transparent;
        }
        .spinning .mini-wheel { animation: spin 0.2s linear infinite; }

        /* æ§åˆ¶å€ */
        .footer { margin: 20px 0; width: 100%; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        #start-btn {
            width: 85%; background: linear-gradient(45deg, #ff003c, #ffea00);
            border: none; padding: 18px; font-size: 1.6rem; font-weight: 900;
            border-radius: 50px; color: #000; box-shadow: 0 0 25px rgba(255,0,60,0.6);
            cursor: pointer;
        }
        #start-btn:disabled { filter: grayscale(1); opacity: 0.5; box-shadow: none; }

        /* å…¨è¢å¹•å¤§é–‹ç */
        #winner-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, #300 0%, #000 100%); 
            display: none; flex-direction: column; align-items: center; justify-content: center; 
            z-index: 1000; text-align: center;
        }
        .winner-title { color: var(--neon-gold); font-size: 2.5rem; letter-spacing: 5px; margin-bottom: 20px; }
        .winner-name { 
            font-size: 6rem; color: #fff; text-shadow: 0 0 50px var(--neon-red), 0 0 100px #fff;
            animation: winnerScale 0.4s infinite alternate;
        }
        .close-win-btn { margin-top: 50px; padding: 15px 50px; background: #fff; color: #000; border-radius: 40px; border: none; font-size: 1.5rem; font-weight: bold; }

        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes pulse { 0% { background: #1a1a1e; } 50% { background: #500; } 100% { background: #1a1a1e; } }
        @keyframes winnerScale { from { transform: scale(1); } to { transform: scale(1.2); } }
        @keyframes flashBg { 0%, 100% { background: #000; } 50% { background: #600; } }
        .flash { animation: flashBg 0.1s 5; }
    </style>
</head>
<body id="main-body">

    <div class="header">
        <h1>âš¡ æ™›èƒ½ 2025 çµ‚æ¥µå¤§é€ƒæ®º âš¡</h1>
        <div class="info-bar" id="game-status">ç¬¬ 1 è¼ª | å‰©é¤˜ï¼š23 äºº</div>
    </div>

    <div class="battle-grid" id="grid"></div>

    <div class="footer">
        <button id="start-btn" onclick="startBattle()">å•Ÿå‹•è½‰ç›¤é–‹çï¼</button>
        <div id="round-log" style="font-size: 0.8rem; color: #666;"></div>
    </div>

    <div id="winner-overlay">
        <div class="winner-title">ğŸŠ ä¸­ ç è€… ğŸŠ</div>
        <div class="winner-name" id="win-name">èŠ³èŠ³å§</div>
        <div style="font-size: 2rem; color: var(--neon-gold); margin-top: 20px;">æ™›èƒ½ç™¼å¤§è²¡ï¼çé‡‘é€²å£è¢‹ï¼</div>
        <button class="close-win-btn" onclick="closeWinner()">ç¢ºèªé ˜ç</button>
    </div>

    <script>
        const allNames = ["é¡§å•", "ä½³ä½³", "å¯Œå“¥", "é™³å§", "æ°‘æ°‘", "å‚‘æ£®", "å°é›ª", "æ€æ¬£", "é˜¿éƒ", "Amyå§", "åº·é›„", "ä½©èŒ¹", "ç¾å¿å§", "ç´èŠ¬å§", "å¨¥å¦¹", "å®¶èˆˆå“¥", "é„­å§”å“¡", "å¹¸ç¦ç”·äºº", "æ¦›æ¦›", "èŠ³èŠ³å§", "çµ²æ·‡", "ä¿¡é–", "å“å›"];
        
        let scores = {};
        let winnersInCurrentRound = []; // æœ¬è¼ªå·²ä¸­çåå–®
        let roundCount = 1; // ç¸½å…±2è¼ª
        let audioCtx;

        function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }

        // åˆæˆï¼šç¾¤çœ¾å°–å«èˆ‡æ­¡å‘¼è²
        function playScreamingCheer() {
            initAudio();
            const now = audioCtx.currentTime;
            
            // æ¨¡æ“¬å°–å« (é«˜é »ç‡æŒ¯ç›ª)
            for(let i=0; i<3; i++){
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(800 + (i*400), now);
                osc.frequency.exponentialRampToValueAtTime(1500 + (i*200), now + 0.5);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 1);
                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.start(); osc.stop(now + 1);
            }

            // æ¨¡æ“¬ç¾¤çœ¾æ­¡å‘¼ (ç™½è‰²å™ªéŸ³æ¿¾æ³¢)
            const bufferSize = audioCtx.sampleRate * 2;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;

            const noise = audioCtx.createBufferSource();
            noise.buffer = buffer;
            const filter = audioCtx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.setValueAtTime(1000, now);
            filter.frequency.exponentialRampToValueAtTime(400, now + 2);
            const nGain = audioCtx.createGain();
            nGain.gain.setValueAtTime(0.3, now);
            nGain.gain.exponentialRampToValueAtTime(0.01, now + 2);
            
            noise.connect(filter); filter.connect(nGain); nGain.connect(audioCtx.destination);
            noise.start();
        }

        function playTick() {
            initAudio();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.setValueAtTime(200, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + 0.05);
        }

        // åˆå§‹åŒ–ç•Œé¢
        function initUI() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            allNames.forEach(n => {
                scores[n] = 0;
                grid.innerHTML += `
                    <div class="slot-card" id="card-${n}">
                        <span class="slot-name">${n}</span>
                        <div class="mini-wheel"></div>
                        <div class="slot-count" id="score-${n}">0</div>
                    </div>
                `;
            });
            updateStatus();
        }

        function updateStatus() {
            const remaining = allNames.length - winnersInCurrentRound.length;
            document.getElementById('game-status').innerText = `ç¬¬ ${roundCount} è¼ª | å‰©é¤˜ï¼š${remaining} äºº`;
            
            // æ¨™è¨˜å·²ä¸­çè€…
            allNames.forEach(n => {
                const card = document.getElementById(`card-${n}`);
                if (winnersInCurrentRound.includes(n)) {
                    card.classList.add('already-won');
                } else {
                    card.classList.remove('already-won');
                }
            });
        }

        async function startBattle() {
            initAudio();
            // æª¢æŸ¥æ˜¯å¦è©²è¼ªå·²çµæŸ
            if (winnersInCurrentRound.length >= allNames.length) {
                if (roundCount < 2) {
                    alert("ç¬¬ 1 è¼ª 23 äººå·²å…¨éƒ¨é–‹çå®Œç•¢ï¼å³å°‡é€²å…¥ç¬¬ 2 è¼ªï¼");
                    roundCount = 2;
                    winnersInCurrentRound = [];
                    initUI();
                    return;
                } else {
                    alert("å…©è¼ªé–‹çå‡å·²çµæŸï¼è¬è¬å¤§å®¶ï¼");
                    return;
                }
            }

            const btn = document.getElementById('start-btn');
            btn.disabled = true;

            // éš¨æ©Ÿé¸å‡ºã€Œæœ¬æŠ½ã€çš„ç²å‹è€… (å¿…é ˆæ˜¯é‚„æ²’ä¸­ççš„äºº)
            const availableNames = allNames.filter(n => !winnersInCurrentRound.includes(n));
            const winnerOfThisSpin = availableNames[Math.floor(Math.random() * availableNames.length)];

            // é‡ç½®ç©åˆ†é¡¯ç¤ºï¼Œä¸¦å•Ÿå‹•å…¨é«”æ—‹è½‰å‹•ç•«
            allNames.forEach(n => {
                scores[n] = 0;
                document.getElementById(`score-${n}`).innerText = 0;
                document.getElementById(`card-${n}`).classList.add('spinning');
            });

            // åŸ·è¡Œç©åˆ†è·‘å‹•å‹•ç•« (40æ­¥)
            const totalSteps = 40;
            for (let i = 0; i < totalSteps; i++) {
                // ç‚ºäº†è¦–è¦ºæ•ˆæœï¼Œè®“æ‰€æœ‰äººéš¨æ©Ÿè·³å‹•åˆ†æ•¸
                const luckyIdx = Math.floor(Math.random() * allNames.length);
                const tempName = allNames[luckyIdx];
                scores[tempName]++;
                document.getElementById(`score-${tempName}`).innerText = scores[tempName];
                
                playTick();
                await new Promise(r => setTimeout(r, Math.max(40, 150 - (i * 4))));
            }

            // ç¢ºä¿ã€Œé å®šç²å‹è€…ã€çš„åˆ†æ•¸æ˜¯æœ€é«˜çš„
            const currentMax = Math.max(...Object.values(scores));
            scores[winnerOfThisSpin] = currentMax + 5; 
            document.getElementById(`score-${winnerOfThisSpin}`).innerText = scores[winnerOfThisSpin];

            // åœæ­¢å‹•ç•«
            allNames.forEach(n => document.getElementById(`card-${n}`).classList.remove('spinning'));

            // è¨˜éŒ„ç²å‹è€…
            winnersInCurrentRound.push(winnerOfThisSpin);

            // æ‡¸å¿µå»¶é²å¾Œå…¬ä½ˆ
            setTimeout(() => {
                showWinner(winnerOfThisSpin);
            }, 500);
        }

        function showWinner(name) {
            document.getElementById('win-name').innerText = name;
            document.getElementById('winner-overlay').style.display = 'flex';
            document.getElementById('main-body').classList.add('flash');
            
            playScreamingCheer();

            if (window.navigator.vibrate) window.navigator.vibrate([300, 100, 300, 100, 500]);
        }

        function closeWinner() {
            document.getElementById('winner-overlay').style.display = 'none';
            document.getElementById('main-body').classList.remove('flash');
            document.getElementById('start-btn').disabled = false;
            updateStatus();

            // å¦‚æœæœ¬è¼ªå‰›å¥½æ˜¯æœ€å¾Œä¸€å€‹ï¼ŒæŒ‰éˆ•æ–‡å­—æ”¹ç‚ºã€Œé€²å…¥ä¸‹ä¸€è¼ªã€
            if (winnersInCurrentRound.length >= allNames.length) {
                document.getElementById('start-btn').innerText = roundCount < 2 ? "é€²å…¥ç¬¬ 2 è¼ªé‡ç½®" : "å…¨è³½äº‹çµæŸ";
            }
        }

        initUI();
    </script>
</body>
</html>
